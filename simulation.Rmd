---
title: "Simulation"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sqldf)
```

## random patients info input
```{r generate variables with no censoring}
set.seed(1)
# simulate age variable for patients and convert to integers
A = round(rnorm(10, mean = 30, sd = 5), 0); A

# generate T variable
T = round(rnorm(10, mean = 60, sd = 5), 0); T

# make sure that T - A is positive
T - A

# add time-dependent variable X(a)
error = round(rnorm(10, mean = 5, sd = 1), 0); error
X_a = 2*A + error; X_a

# create patient ID numbers
id = 1:10

patient_info_baseline = cbind(id, A, X_a, T) %>% as.data.frame()

# generate time-dependent predictors
id = c(rep(1, 3), rep(2, 3), rep(3, 3), rep(4, 3), rep(5, 3), rep(6, 3), rep(7, 3), rep(8, 3), rep(9, 3), rep(10, 3)); id

visit = c(rep(1:3, 10)); visit

error2 = round(rnorm(10, mean = 5, sd = 0.1), 0)
X_t = X_a + visit + error2; X_t

time_dependent_info = cbind(id, visit, X_t) %>% as.data.frame()

# left join two datasets using SQL syntax
patients = sqldf("SELECT *
                  FROM patient_info_baseline AS p
                  LEFT JOIN time_dependent_info AS j
                  ON p.id = j.id
                 ")

# tidy data and ensure A is also changing over time
patients_tidy = 
  patients %>% 
  select(-id..5) %>% 
  group_by(id) %>% 
  mutate(A = A + visit)

# view data
patients_tidy

```

## survival prediction
```{r within-cluster resampling}
# write a function to conduct within-cluster resampling
# data is clustered by repeated visits for one individual
# write function to randomly select one record from one individual and store the results
cluster_sample_selection = function(dataframe) {
  sample_dataframe = 
    dataframe %>% 
    group_by(id) %>% 
    sample_n(size = 1)
  return(sample_dataframe)  
}

# test whether this function works
test = cluster_sample_selection(patients_tidy); test

# write a function to conduct repeated survival analysis for each resampled data
# declare some variables beforehands
survival_rate_sum = 0 
# write a for loop to calculate survival rate using random forests
for(i in 1:1000) {
  data = cluster_sample_selection(patients_tidy)
  # let T be the outcome varaible and fit random forests model
  
}
```

